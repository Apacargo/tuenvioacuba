<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rastreo de Env√≠os | Apacargo</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f3f6fa;
      margin: 0;
      color: #002b7f;
    }
    header {
      background: linear-gradient(90deg, #002b7f, #d4af37);
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 1.4rem;
      font-weight: bold;
      letter-spacing: 1px;
    }
    main {
      max-width: 600px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #001f4d; }
    .tracker {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 1rem 0;
    }
    input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #d4af37;
      color: #001f4d;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 18px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #b38f2a; }
    #trackResult {
      background: #eef1f8;
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
      display: none;
    }
    footer {
      background: #001f4d;
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 14px;
      margin-top: 2rem;
    }
    .hidden { display: none; }

    /* Admin panel */
    #adminPanel {
      display: none;
      margin-top: 2rem;
      background: #f8f9fb;
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 1.5rem;
    }
    #adminPanel input, #adminPanel textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn:hover { background: #c0392b; }
  </style>
</head>
<body>
  <header>
    <img src="images/logo.png" alt="Apacargo" style="height:60px; vertical-align:middle;">
    <div>Rastreo de Env√≠os</div>
  </header>

  <main>
    <h2>Consulta tu Env√≠o</h2>
    <p>Introduce tu n√∫mero de seguimiento (ejemplo: AP-2025-000123)</p>
    <div class="tracker">
      <input id="trackId" placeholder="Ej: AP-2025-000123" />
      <button onclick="trackLookup()">Rastrear</button>
    </div>

    <div id="trackResult"></div>

    <div id="adminPanel">
      <h3>Panel Administrativo</h3>
      <input id="codigo" placeholder="C√≥digo de env√≠o (AP-XXXX-XXXX)" />
      <input id="cliente" placeholder="Nombre del cliente" />
      <textarea id="estado" placeholder="Estado del env√≠o"></textarea>
      <button onclick="agregarEnvio()">Agregar / Actualizar Env√≠o</button>

      <h4>Lista de Env√≠os</h4>
      <div id="enviosLista"></div>
    </div>
  </main>

  <footer>¬© 2025 Apacargo ‚Äì Todos los derechos reservados</footer>

  <!-- SCRIPT SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîß Configura tus credenciales de Supabase
    const SUPABASE_URL = "https://nqzpmhlxknbtkthifzqt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenBtaGx4a25idGt0aGlmenF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTE4ODgsImV4cCI6MjA3NjgyNzg4OH0.1JQTXbdTslRUz9VTeXB5rq6I-aKhdQ-lDC51QMpMGqU";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const WHATS_NUMBER = "5350896082";

    // üïµÔ∏è Entrada secreta al panel admin
    document.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "j") {
        const clave = prompt("Introduce la clave secreta:");
        if (clave === "jackson") {
          document.getElementById("adminPanel").style.display = "block";
          alert("‚úÖ Acceso concedido al panel administrativo.");
          cargarEnvios();
        }
      }
    });

    // üîç Buscar env√≠o
    async function trackLookup() {
      const code = document.getElementById("trackId").value.trim();
      if (!code) return alert("Por favor introduce un c√≥digo.");

      const { data, error } = await supabase
        .from("rastreo")
        .select("*")
        .eq("codigo", code);

      const resultDiv = document.getElementById("trackResult");
      if (error) {
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "‚ùå Error al consultar.";
        return;
      }

      if (data.length === 0) {
        resultDiv.style.display = "block";
        resultDiv.innerHTML = "‚ö†Ô∏è No se encontr√≥ ning√∫n env√≠o con ese c√≥digo.";
      } else {
        const envio = data[0];
        resultDiv.style.display = "block";
        resultDiv.innerHTML = `
          <strong>Cliente:</strong> ${envio.cliente}<br>
          <strong>Estado:</strong> ${envio.estado || "En proceso"}<br>
          <button style="margin-top:8px;background:#25D366;color:white;border:none;padding:8px 12px;border-radius:8px;"
            onclick="window.open('https://wa.me/${WHATS_NUMBER}?text=Hola, necesito informaci√≥n sobre el env√≠o ${envio.codigo}','_blank')">
            Contactar por WhatsApp
          </button>`;
      }
    }

    // üóÇÔ∏è Cargar lista de env√≠os (admin)
    async function cargarEnvios() {
      const { data, error } = await supabase.from("rastreo").select("*");
      const contenedor = document.getElementById("enviosLista");
      contenedor.innerHTML = "";
      if (error) return alert("Error al cargar: " + error.message);

      data.forEach((envio) => {
        const div = document.createElement("div");
        div.style.marginBottom = "10px";
        div.innerHTML = `
          <b>${envio.codigo}</b> - ${envio.cliente}<br>
          Estado: ${envio.estado || "N/A"}
          <button class="delete-btn" onclick="eliminarEnvio('${envio.id}')">Eliminar</button>
        `;
        contenedor.appendChild(div);
      });
    }

    // ‚ûï Agregar env√≠o
    async function agregarEnvio() {
      const codigo = document.getElementById("codigo").value.trim();
      const cliente = document.getElementById("cliente").value.trim();
      const estado = document.getElementById("estado").value.trim();

      if (!codigo || !cliente) return alert("Rellena todos los campos.");

      const { error } = await supabase.from("rastreo").upsert({ codigo, cliente, estado });
      if (error) return alert("Error al guardar: " + error.message);

      alert("‚úÖ Env√≠o guardado correctamente.");
      cargarEnvios();
    }

    // üóëÔ∏è Eliminar env√≠o
    async function eliminarEnvio(id) {
      if (!confirm("¬øEliminar este env√≠o?")) return;
      const { error } = await supabase.from("rastreo").delete().eq("id", id);
      if (error) return alert("Error al eliminar: " + error.message);
      alert("üóëÔ∏è Env√≠o eliminado.");
      cargarEnvios();
    }
  </script>
</body>
</html>
