<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo | Apacargo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { 
      font-family: "Poppins", sans-serif;
      background: #f4f7fb;
      margin: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #004aad, #d4af37);
      color: #fff;
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
    }
    .login-box {
      background: white;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      margin: 100px auto;
      text-align: center;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 15px;
      margin: 5px 0 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
    }
    button {
      background: #d4af37;
      border: none;
      padding: 12px 25px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }
    button:hover { background: #b9932f; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #004aad;
      color: white;
    }
    .hidden { display: none; }
    .new-form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .new-form h2 { color: #004aad; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>üîê Panel Administrativo | Apacargo</header>

  <!-- LOGIN -->
  <div id="login" class="login-box">
    <h2>Acceso Restringido</h2>
    <p>Introduce tus credenciales para ingresar al panel</p>
    <input id="user" placeholder="Usuario" />
    <input id="pass" type="password" placeholder="Contrase√±a" />
    <button onclick="login()">Ingresar</button>
    <div id="loginMsg" style="color:red;margin-top:10px;"></div>
  </div>

  <!-- PANEL -->
  <main id="panel" class="hidden">

    <!-- FORMULARIO NUEVO ENV√çO -->
    <div class="new-form">
      <h2>Agregar Nuevo Env√≠o</h2>
      <input id="new_tracking_id" placeholder="Tracking ID" />
      <input id="new_codigo" placeholder="C√≥digo del env√≠o" />
      <input id="new_cliente" placeholder="Cliente" />
      <select id="new_estado">
        <option value="">Seleccionar estado...</option>
        <option>Recibido en Miami</option>
        <option>En tr√°nsito hacia Cuba</option>
        <option>En Aduana de La Habana</option>
        <option>En distribuci√≥n</option>
        <option>Entregado</option>
      </select>
      <input id="new_ubicacion" placeholder="Ubicaci√≥n actual" />
      <textarea id="new_notas" placeholder="Notas (opcional)"></textarea>
      <button onclick="agregarEnvio()">‚ûï Agregar Env√≠o</button>
    </div>

    <!-- TABLA DE ENV√çOS -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Tracking</th>
          <th>C√≥digo</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Ubicaci√≥n</th>
          <th>Notas</th>
          <th>√öltima actualizaci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="enviosList">
        <tr><td colspan="9" style="text-align:center;">Cargando env√≠os...</td></tr>
      </tbody>
    </table>
  </main>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = "https://nqzpmhlxknbtkthifzqt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xenBtaGx4a25idGt0aGlmenF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTE4ODgsImV4cCI6MjA3NjgyNzg4OH0.1JQTXbdTslRUz9VTeXB5rq6I-aKhdQ-lDC51QMpMGqU"; // reemplaza con tu anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const ADMIN_USER = "JMS";
    const ADMIN_PASS = "jms980320";

    window.login = () => {
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value.trim();
      const msg = document.getElementById("loginMsg");

      if (user === ADMIN_USER && pass === ADMIN_PASS) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("panel").classList.remove("hidden");
        cargarEnvios();
      } else {
        msg.textContent = "Usuario o contrase√±a incorrectos.";
      }
    };

    async function cargarEnvios() {
      const { data, error } = await supabase
        .from("rastreo")
        .select("*")
        .order("fecha_actualizacion", { ascending: false });

      const tbody = document.getElementById("enviosList");
      if (error) {
        tbody.innerHTML = `<tr><td colspan="9">Error: ${error.message}</td></tr>`;
        return;
      }

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="9">No hay env√≠os registrados a√∫n.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(envio => `
        <tr>
          <td>${envio.id}</td>
          <td>${envio.tracking_id}</td>
          <td>${envio.codigo}</td>
          <td><input value="${envio.cliente}" id="cliente-${envio.id}"/></td>
          <td><input value="${envio.estado}" id="estado-${envio.id}"/></td>
          <td><input value="${envio.ubicacion}" id="ubicacion-${envio.id}"/></td>
          <td><input value="${envio.notas || ''}" id="notas-${envio.id}"/></td>
          <td>${new Date(envio.fecha_actualizacion).toLocaleString()}</td>
          <td>
            <button onclick="actualizar(${envio.id})">üíæ</button>
            <button onclick="eliminar(${envio.id})" style="background:#c0392b;">üóëÔ∏è</button>
          </td>
        </tr>
      `).join("");
    }

    window.actualizar = async (id) => {
      const cliente = document.getElementById(`cliente-${id}`).value;
      const estado = document.getElementById(`estado-${id}`).value;
      const ubicacion = document.getElementById(`ubicacion-${id}`).value;
      const notas = document.getElementById(`notas-${id}`).value;

      const { error } = await supabase
        .from("rastreo")
        .update({ cliente, estado, ubicacion, notas, fecha_actualizacion: new Date() })
        .eq("id", id);

      if (error) return alert("Error al actualizar: " + error.message);
      cargarEnvios();
    };

    window.eliminar = async (id) => {
      if (!confirm("¬øSeguro que deseas eliminar este env√≠o?")) return;

      const { error } = await supabase
        .from("rastreo")
        .delete()
        .eq("id", id);

      if (error) return alert("Error al eliminar: " + error.message);
      cargarEnvios();
    };

    window.agregarEnvio = async () => {
      const tracking_id = document.getElementById("new_tracking_id").value.trim();
      const codigo = document.getElementById("new_codigo").value.trim();
      const cliente = document.getElementById("new_cliente").value.trim();
      const estado = document.getElementById("new_estado").value;
      const ubicacion = document.getElementById("new_ubicacion").value.trim();
      const notas = document.getElementById("new_notas").value.trim();

      if (!tracking_id || !codigo || !cliente || !estado || !ubicacion) {
        return alert("Completa todos los campos obligatorios.");
      }

      const { error } = await supabase
        .from("rastreo")
        .insert([{ tracking_id, codigo, cliente, estado, ubicacion, notas, fecha_actualizacion: new Date() }]);

      if (error) return alert("Error al agregar: " + error.message);

      // Limpiar formulario
      document.getElementById("new_tracking_id").value = "";
      document.getElementById("new_codigo").value = "";
      document.getElementById("new_cliente").value = "";
      document.getElementById("new_estado").value = "";
      document.getElementById("new_ubicacion").value = "";
      document.getElementById("new_notas").value = "";

      cargarEnvios();
    };
  </script>
</body>
</html>
