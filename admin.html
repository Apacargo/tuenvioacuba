<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo | Apacargo</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-wrap { max-width:1100px; margin:20px auto; padding:0 12px; }
    .small { font-size:0.9rem; color:#666; }
    table input { width: 100%; padding:6px; border-radius:6px; border:1px solid #ddd; }
    .actions button { margin-right:6px; }
    .hint { font-size:0.95rem; color:#444; margin-bottom:8px; }
  </style>
</head>
<body>
  <header>üîê Panel Administrativo | Apacargo</header>

  <main class="admin-wrap">
    <!-- BOX: si no hay sesi√≥n, mostramos formulario para ingresar clave -->
    <div id="noSessionBox" class="box" style="max-width:420px;margin:24px auto;">
      <h2>Acceso Administrador (clave secreta)</h2>
      <p class="hint">Introduce la clave secreta para abrir el panel.</p>
      <input id="secretInput" placeholder="Clave secreta" />
      <button id="secretBtn">Entrar</button>
      <div id="secretMsg" style="margin-top:10px;color:#b00020"></div>
    </div>

    <!-- PANEL (oculto si no hay sesi√≥n) -->
    <section id="panel" class="hidden">
      <div class="new-form">
        <h2>‚ûï Agregar / Nuevo Env√≠o</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="new_tracking_id" placeholder="Tracking ID (opcional)" style="flex:1 1 200px;">
          <input id="new_codigo" placeholder="C√≥digo del env√≠o (oblig.)" style="flex:1 1 200px;">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <input id="new_cliente" placeholder="Cliente" style="flex:1 1 200px;">
          <input id="new_ubicacion" placeholder="Ubicaci√≥n" style="flex:1 1 200px;">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <select id="new_estado" style="flex:1 1 200px;">
            <option value="">Seleccionar estado...</option>
            <option>Recibido en Miami</option>
            <option>En tr√°nsito hacia Cuba</option>
            <option>En Aduana de La Habana</option>
            <option>En distribuci√≥n</option>
            <option>Entregado</option>
          </select>
          <input id="new_destino" placeholder="Destino (p. ej. Holgu√≠n)" style="flex:1 1 200px;">
        </div>
        <textarea id="new_notas" placeholder="Notas (opcional)" style="margin-top:8px;"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addBtn">Agregar Env√≠o</button>
          <button id="logoutBtn" style="background:#c0392b">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div style="margin-top:18px;">
        <h2>üìã Env√≠os Registrados</h2>
        <div id="loadingList" class="small">Cargando env√≠os...</div>
        <div style="overflow:auto;">
          <table id="tableEnvios" style="width:100%;margin-top:8px;">
            <thead>
              <tr style="background:#004aad;color:#fff">
                <th>Tracking</th><th>C√≥digo</th><th>Cliente</th><th>Estado</th><th>Ubicaci√≥n</th><th>Destino</th><th>Notas</th><th>√öltima</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="enviosList"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer style="margin-top:40px;text-align:center;color:#fff;background:#004aad;padding:14px;">¬© 2025 Apacargo</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- TU FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDUqgpXR7v5y0JqtNgEz7JMWIvOmRNerXI",
      authDomain: "apacargo-tracking.firebaseapp.com",
      projectId: "apacargo-tracking",
      storageBucket: "apacargo-tracking.firebasestorage.app",
      messagingSenderId: "553785487239",
      appId: "1:553785487239:web:9b8c1cc17bbc1e7f76ad22"
    };

    const SECRET = 'jackson'; // <-- la misma clave que en rastreo.html (c√°mbiala si deseas otra)

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const noSessionBox = document.getElementById('noSessionBox');
    const panel = document.getElementById('panel');
    const secretBtn = document.getElementById('secretBtn');
    const secretInput = document.getElementById('secretInput');
    const secretMsg = document.getElementById('secretMsg');
    const logoutBtn = document.getElementById('logoutBtn');

    // Comprueba si hay sesi√≥n de admin
    function isAdmin() {
      return sessionStorage.getItem('apacargo_admin') === '1';
    }

    function showPanel() {
      noSessionBox.classList.add('hidden');
      panel.classList.remove('hidden');
      cargarEnvios();
    }
    function hidePanel() {
      noSessionBox.classList.remove('hidden');
      panel.classList.add('hidden');
    }

    // Si la sesi√≥n ya est√° activa mostramos el panel
    if (isAdmin()) {
      showPanel();
    } else {
      hidePanel();
    }

    secretBtn.addEventListener('click', () => {
      const v = (secretInput.value || '').trim();
      secretMsg.textContent = '';
      if (!v) { secretMsg.textContent = 'Introduce la clave.'; return; }
      if (v.toLowerCase() === SECRET.toLowerCase()) {
        sessionStorage.setItem('apacargo_admin', '1');
        showPanel();
      } else {
        secretMsg.textContent = 'Clave incorrecta.';
      }
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('apacargo_admin');
      location.reload();
    });

    // CRUD
    const enviosListEl = document.getElementById('enviosList');
    const loadingList = document.getElementById('loadingList');
    const addBtn = document.getElementById('addBtn');

    addBtn.addEventListener('click', agregarEnvio);

    async function cargarEnvios() {
      loadingList.textContent = 'Cargando env√≠os...';
      enviosListEl.innerHTML = '';
      try {
        const snap = await getDocs(collection(db, 'rastreo'));
        if (snap.empty) {
          loadingList.textContent = 'No hay env√≠os registrados.';
          return;
        }
        loadingList.textContent = '';
        let rows = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          rows += `
            <tr>
              <td>${escapeHtml(d.tracking_id || '')}</td>
              <td>${escapeHtml(d.codigo || '')}</td>
              <td><input id="cliente-${id}" value="${escapeHtml(d.cliente||'')}" /></td>
              <td><input id="estado-${id}" value="${escapeHtml(d.estado||'')}" /></td>
              <td><input id="ubicacion-${id}" value="${escapeHtml(d.ubicacion||'')}" /></td>
              <td><input id="destino-${id}" value="${escapeHtml(d.destino||'')}" /></td>
              <td><input id="notas-${id}" value="${escapeHtml(d.notas||'')}" /></td>
              <td>${d.fecha_actualizacion ? new Date(d.fecha_actualizacion.seconds * 1000).toLocaleString() : '‚Äî'}</td>
              <td class="actions">
                <button onclick="actualizar('${id}')">üíæ</button>
                <button onclick="eliminar('${id}')" style="background:#c0392b;">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        });
        enviosListEl.innerHTML = rows;
      } catch (err) {
        console.error(err);
        loadingList.textContent = 'Error cargando env√≠os.';
      }
    }

    window.actualizar = async (id) => {
      try {
        const ref = doc(db, 'rastreo', id);
        const cliente = document.getElementById(`cliente-${id}`).value.trim();
        const estado = document.getElementById(`estado-${id}`).value.trim();
        const ubicacion = document.getElementById(`ubicacion-${id}`).value.trim();
        const destino = document.getElementById(`destino-${id}`).value.trim();
        const notas = document.getElementById(`notas-${id}`).value.trim();
        await updateDoc(ref, {
          cliente, estado, ubicacion, destino, notas,
          fecha_actualizacion: serverTimestamp()
        });
        await cargarEnvios();
        alert('‚úÖ Env√≠o actualizado');
      } catch (err) {
        console.error(err);
        alert('Error al actualizar');
      }
    };

    window.eliminar = async (id) => {
      if (!confirm('¬øEliminar env√≠o?')) return;
      try {
        await deleteDoc(doc(db, 'rastreo', id));
        await cargarEnvios();
        alert('‚úÖ Env√≠o eliminado');
      } catch (err) {
        console.error(err);
        alert('Error al eliminar');
      }
    };

    async function agregarEnvio() {
      const tracking_id = document.getElementById('new_tracking_id').value.trim();
      const codigo = document.getElementById('new_codigo').value.trim();
      const cliente = document.getElementById('new_cliente').value.trim();
      const ubicacion = document.getElementById('new_ubicacion').value.trim();
      const estado = document.getElementById('new_estado').value;
      const destino = document.getElementById('new_destino').value.trim();
      const notas = document.getElementById('new_notas').value.trim();

      if (!codigo || !cliente || !estado) {
        alert('Completa los campos obligatorios (c√≥digo, cliente, estado).');
        return;
      }

      try {
        await addDoc(collection(db, 'rastreo'), {
          tracking_id, codigo, cliente, ubicacion, estado, destino, notas,
          fecha_actualizacion: serverTimestamp()
        });
        // limpiar campos
        document.getElementById('new_tracking_id').value = '';
        document.getElementById('new_codigo').value = '';
        document.getElementById('new_cliente').value = '';
        document.getElementById('new_ubicacion').value = '';
        document.getElementById('new_destino').value = '';
        document.getElementById('new_notas').value = '';
        document.getElementById('new_estado').value = '';
        await cargarEnvios();
        alert('‚úÖ Env√≠o agregado');
      } catch (err) {
        console.error(err);
        alert('Error al agregar env√≠o');
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
