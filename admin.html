<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo | Apacargo</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f4f7fb;
      margin: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #004aad, #d4af37);
      color: #fff;
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main { max-width: 1000px; margin: 20px auto; padding: 20px; }
    .login-box {
      background: white; padding: 30px 40px; border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 400px; margin: 100px auto; text-align: center;
    }
    input, select, textarea {
      width: 100%; padding: 10px 15px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 10px; font-size: 1rem;
    }
    button {
      background: #d4af37; border: none; padding: 12px 25px;
      border-radius: 30px; color: white; font-weight: bold;
      cursor: pointer; transition: 0.3s; margin-top: 10px;
    }
    button:hover { background: #b9932f; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 30px;
      background: white; border-radius: 10px; overflow: hidden;
    }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #004aad; color: white; }
    .hidden { display: none; }
    .new-form {
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px;
    }
    .new-form h2 { color: #004aad; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>üîê Panel Administrativo | Apacargo</header>

  <div id="login" class="login-box">
    <h2>Acceso Restringido</h2>
    <input id="user" placeholder="Usuario" />
    <input id="pass" type="password" placeholder="Contrase√±a" />
    <button onclick="login()">Ingresar</button>
    <div id="loginMsg" style="color:red;margin-top:10px;"></div>
  </div>

  <main id="panel" class="hidden">
    <div class="new-form">
      <h2>Agregar Nuevo Env√≠o</h2>
      <input id="new_tracking_id" placeholder="Tracking ID" />
      <input id="new_codigo" placeholder="C√≥digo del env√≠o" />
      <input id="new_cliente" placeholder="Cliente" />
      <select id="new_estado">
        <option value="">Seleccionar estado...</option>
        <option>Recibido en Miami</option>
        <option>En tr√°nsito hacia Cuba</option>
        <option>En Aduana de La Habana</option>
        <option>En distribuci√≥n</option>
        <option>Entregado</option>
      </select>
      <input id="new_ubicacion" placeholder="Ubicaci√≥n actual" />
      <textarea id="new_notas" placeholder="Notas (opcional)"></textarea>
      <button onclick="agregarEnvio()">‚ûï Agregar Env√≠o</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Tracking</th><th>C√≥digo</th><th>Cliente</th>
          <th>Estado</th><th>Ubicaci√≥n</th><th>Notas</th>
          <th>√öltima actualizaci√≥n</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="enviosList"><tr><td colspan="8">Cargando...</td></tr></tbody>
    </table>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUqgpXR7v5y0JqtNgEz7JMWIvOmRNerXI",
      authDomain: "apacargo-tracking.firebaseapp.com",
      projectId: "apacargo-tracking",
      storageBucket: "apacargo-tracking.firebasestorage.app",
      messagingSenderId: "553785487239",
      appId: "1:553785487239:web:9b8c1cc17bbc1e7f76ad22"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ADMIN_USER = "JMS";
    const ADMIN_PASS = "jms980320";

    window.login = () => {
      const user = userInput.value.trim();
      const pass = passInput.value.trim();
      if (user === ADMIN_USER && pass === ADMIN_PASS) {
        loginBox.classList.add("hidden");
        panel.classList.remove("hidden");
        cargarEnvios();
      } else loginMsg.textContent = "Usuario o contrase√±a incorrectos.";
    };

    const userInput = document.getElementById("user");
    const passInput = document.getElementById("pass");
    const loginBox = document.getElementById("login");
    const loginMsg = document.getElementById("loginMsg");
    const panel = document.getElementById("panel");

    async function cargarEnvios() {
      const tbody = document.getElementById("enviosList");
      const snapshot = await getDocs(collection(db, "rastreo"));
      let html = "";
      snapshot.forEach(docSnap => {
        const e = docSnap.data();
        html += `
        <tr>
          <td>${e.tracking_id}</td>
          <td>${e.codigo}</td>
          <td><input value="${e.cliente}" id="cliente-${docSnap.id}" /></td>
          <td><input value="${e.estado}" id="estado-${docSnap.id}" /></td>
          <td><input value="${e.ubicacion}" id="ubicacion-${docSnap.id}" /></td>
          <td><input value="${e.notas || ''}" id="notas-${docSnap.id}" /></td>
          <td>${new Date(e.fecha_actualizacion?.seconds * 1000 || Date.now()).toLocaleString()}</td>
          <td>
            <button onclick="actualizar('${docSnap.id}')">üíæ</button>
            <button onclick="eliminar('${docSnap.id}')" style="background:#c0392b;">üóëÔ∏è</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html || "<tr><td colspan='8'>No hay env√≠os</td></tr>";
    }

    window.agregarEnvio = async () => {
      const tracking_id = document.getElementById("new_tracking_id").value.trim();
      const codigo = document.getElementById("new_codigo").value.trim();
      const cliente = document.getElementById("new_cliente").value.trim();
      const estado = document.getElementById("new_estado").value;
      const ubicacion = document.getElementById("new_ubicacion").value.trim();
      const notas = document.getElementById("new_notas").value.trim();
      if (!tracking_id || !codigo || !cliente || !estado || !ubicacion) return alert("Completa todos los campos.");

      await addDoc(collection(db, "rastreo"), {
        tracking_id, codigo, cliente, estado, ubicacion, notas,
        fecha_actualizacion: serverTimestamp()
      });
      alert("Env√≠o agregado ‚úÖ");
      cargarEnvios();
    };

    window.actualizar = async (id) => {
      const ref = doc(db, "rastreo", id);
      const cliente = document.getElementById(`cliente-${id}`).value;
      const estado = document.getElementById(`estado-${id}`).value;
      const ubicacion = document.getElementById(`ubicacion-${id}`).value;
      const notas = document.getElementById(`notas-${id}`).value;
      await updateDoc(ref, { cliente, estado, ubicacion, notas, fecha_actualizacion: serverTimestamp() });
      cargarEnvios();
    };

    window.eliminar = async (id) => {
      if (confirm("¬øEliminar env√≠o?")) {
        await deleteDoc(doc(db, "rastreo", id));
        cargarEnvios();
      }
    };
  </script>
</body>
</html>
