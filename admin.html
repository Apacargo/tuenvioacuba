<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo | Apacargo</title>
  <style>
    body { 
      font-family: "Poppins", sans-serif;
      background: #f4f7fb;
      margin: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #004aad, #d4af37);
      color: #fff;
      text-align: center;
      padding: 20px;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 1px;
    }
    main { max-width: 1000px; margin: 20px auto; padding: 20px; }
    .login-box {
      background: white; padding: 30px 40px; border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 400px; margin: 100px auto; text-align: center;
    }
    input, select, textarea {
      width: 100%; padding: 10px 15px; margin: 5px 0 15px;
      border: 1px solid #ccc; border-radius: 10px; font-size: 1rem;
    }
    button {
      background: #d4af37; border: none; padding: 12px 25px;
      border-radius: 30px; color: white; font-weight: bold;
      cursor: pointer; transition: 0.3s; margin-top: 10px;
    }
    button:hover { background: #b9932f; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 30px;
      background: white; border-radius: 10px; overflow: hidden;
    }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #004aad; color: white; }
    .hidden { display: none; }
    .new-form {
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px;
    }
    .new-form h2 { color: #004aad; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>üîê Panel Administrativo | Apacargo</header>

  <!-- LOGIN -->
  <div id="login" class="login-box">
    <h2>Acceso Restringido</h2>
    <input id="user" placeholder="Usuario" />
    <input id="pass" type="password" placeholder="Contrase√±a" />
    <button onclick="login()">Ingresar</button>
    <div id="loginMsg" style="color:red;margin-top:10px;"></div>
  </div>

  <!-- PANEL -->
  <main id="panel" class="hidden">
    <div class="new-form">
      <h2>Agregar Nuevo Env√≠o</h2>
      <input id="new_codigo" placeholder="C√≥digo del env√≠o" />
      <input id="new_cliente" placeholder="Cliente" />
      <select id="new_estado">
        <option value="">Seleccionar estado...</option>
        <option>Recibido en Miami</option>
        <option>En tr√°nsito hacia Cuba</option>
        <option>En Aduana de La Habana</option>
        <option>En distribuci√≥n</option>
        <option>Entregado</option>
      </select>
      <input id="new_ubicacion" placeholder="Ubicaci√≥n actual" />
      <textarea id="new_notas" placeholder="Notas (opcional)"></textarea>
      <button onclick="agregarEnvio()">‚ûï Agregar Env√≠o</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>C√≥digo</th><th>Cliente</th>
          <th>Estado</th><th>Ubicaci√≥n</th><th>Notas</th>
          <th>√öltima actualizaci√≥n</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="enviosList"><tr><td colspan="8" style="text-align:center;">Cargando...</td></tr></tbody>
    </table>
  </main>

  <script type="module">
    // --- üî• Firebase Import ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // üöÄ TU CONFIGURACI√ìN FIREBASE AQU√ç
    const firebaseConfig = {
      apiKey: "AIzaSyDUqgpXR7v5y0JqtNgEz7JMWIvOmRNerXI",
      authDomain: "apacargo-tracking.firebaseapp.com",
      projectId: "apacargo-tracking",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ADMIN_USER = "JMS";
    const ADMIN_PASS = "jms980320";

    window.login = () => {
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value.trim();
      const msg = document.getElementById("loginMsg");
      if (user === ADMIN_USER && pass === ADMIN_PASS) {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("panel").classList.remove("hidden");
        cargarEnvios();
      } else msg.textContent = "Usuario o contrase√±a incorrectos.";
    };

    async function cargarEnvios() {
      const tbody = document.getElementById("enviosList");
      const snap = await getDocs(collection(db, "rastreo"));
      if (snap.empty) {
        tbody.innerHTML = "<tr><td colspan='8'>No hay env√≠os registrados.</td></tr>";
        return;
      }
      let html = "";
      snap.forEach((d) => {
        const e = d.data();
        html += `
          <tr>
            <td>${d.id}</td>
            <td><input id="codigo-${d.id}" value="${e.codigo}"></td>
            <td><input id="cliente-${d.id}" value="${e.cliente}"></td>
            <td><input id="estado-${d.id}" value="${e.estado}"></td>
            <td><input id="ubicacion-${d.id}" value="${e.ubicacion}"></td>
            <td><input id="notas-${d.id}" value="${e.notas || ''}"></td>
            <td>${e.fecha_actualizacion ? new Date(e.fecha_actualizacion.seconds*1000).toLocaleString() : '‚Äî'}</td>
            <td>
              <button onclick="actualizar('${d.id}')">üíæ</button>
              <button onclick="eliminar('${d.id}')" style="background:#c0392b;">üóëÔ∏è</button>
            </td>
          </tr>`;
      });
      tbody.innerHTML = html;
    }

    window.actualizar = async (id) => {
      const ref = doc(db, "rastreo", id);
      await updateDoc(ref, {
        codigo: document.getElementById(`codigo-${id}`).value,
        cliente: document.getElementById(`cliente-${id}`).value,
        estado: document.getElementById(`estado-${id}`).value,
        ubicacion: document.getElementById(`ubicacion-${id}`).value,
        notas: document.getElementById(`notas-${id}`).value,
        fecha_actualizacion: serverTimestamp()
      });
      alert("‚úÖ Env√≠o actualizado");
      cargarEnvios();
    };

    window.eliminar = async (id) => {
      if (!confirm("¬øSeguro que deseas eliminar este env√≠o?")) return;
      await deleteDoc(doc(db, "rastreo", id));
      cargarEnvios();
    };

    window.agregarEnvio = async () => {
      const codigo = document.getElementById("new_codigo").value.trim();
      const cliente = document.getElementById("new_cliente").value.trim();
      const estado = document.getElementById("new_estado").value;
      const ubicacion = document.getElementById("new_ubicacion").value.trim();
      const notas = document.getElementById("new_notas").value.trim();
      if (!codigo || !cliente || !estado || !ubicacion) {
        alert("Completa todos los campos obligatorios.");
        return;
      }
      await addDoc(collection(db, "rastreo"), {
        codigo, cliente, estado, ubicacion, notas, fecha_actualizacion: serverTimestamp()
      });
      alert("‚úÖ Env√≠o agregado correctamente");
      cargarEnvios();
    };
  </script>
</body>
</html>
